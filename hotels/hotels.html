<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Guide</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: url('https://lh3.googleusercontent.com/pw/AP1GczP6EnwFICLhjFUUa1dS8owbtTDA8AEHN9efTje_ru3SWVEUnT7Tn23hgZ-vlIj4YdRZfAKxZNd3tmKxAb-iYpKx1AXF1iHO12SZcxZaN8RadTEYqBEUnNZTMLJwZPZUCaUpqHxLNwSNuE8zixLxmNd7=w514-h913-s-no-gm?authuser=0') no-repeat center center fixed;
            background-size: cover;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            /* Full viewport height */
            width: 100vw;
            /* Full viewport width */
            margin: 0;
            padding: 0;
        }

        /* Left Side Content */
        .left-side {
            width: 400px;
            /* Fixed width for the left side */
            background: rgba(255, 255, 255, 0.9);
            /* Semi-transparent white background */
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background: url('hotels.jpg') no-repeat center center fixed;
            background-size: cover;
            overflow-y: auto;
            /* Enable scrolling if content overflows */
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #recommendations {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        #recommendations h3 {
            margin-top: 0;
            color: #007bff;
        }

        #results {
            list-style-type: none;
            padding: 0;
        }

        .result-item {
            margin-bottom: 20px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
        }

        .result-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        .result-name {
            font-weight: bold;
            margin-top: 10px;
            font-size: 18px;
        }

        .result-rating {
            font-size: 14px;
            color: #777;
        }

        .gmaps-link {
            display: inline-block;
            margin-top: 5px;
            font-size: 14px;
            color: #007bff;
            text-decoration: none;
        }

        .result-distance {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 36px;
            color: #007bff;
        }

        #controls {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        #controls input {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 250px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #controls input:focus {
            border-color: #007bff;
        }

        #controls select {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #controls select:focus {
            border-color: #007bff;
        }

        #controls button {
            padding: 12px 24px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #controls button:hover {
            background: #0056b3;
        }

        /* Current Location Button (bottom-right) */
        #current-location-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 7;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: background 0.3s ease;
        }

        #current-location-btn:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="left-side">
            <header>
                <h1>Travel Guide</h1>
            </header>
            <div id="controls">
                <input type="text" id="to" placeholder="Enter destination" />
                <select id="menu">
                    <option value="restaurant">Restaurants</option>
                    <option value="hotel">Hotels</option>
                    <option value="tourist_attraction">Attractions</option>
                    <option value="hospital">Hospitals</option>
                    <option value="car_repair">Mechanics</option>
                    <option value="rentals">Rentals</option>
                </select>
                <select id="rating">
                    <option value="all">All</option>
                    <option value="4.0">Above 4.0</option>
                    <option value="3.0">Above 3.0</option>
                    <option value="2.0">Above 2.0</option>
                </select>
                <button id="search">Search</button>
            </div>
            <div id="recommendations">
                <h3>Search Recommendations</h3>
                <ul id="results"></ul>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- Current Location Button -->
    <button id="current-location-btn">Current Location</button>

    <script>
        let map;
        let autocompleteTo;
        let placesService;
        let markers = [];
        let currentLocationMarker = null;
        let currentPosition = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: {
                    lat: 37.7749,
                    lng: -122.4194
                },
                zoom: 13,
            });

            autocompleteTo = new google.maps.places.Autocomplete(
                document.getElementById("to"), {
                    types: ["geocode"]
                }
            );

            autocompleteTo.addListener("place_changed", () => {
                const place = autocompleteTo.getPlace();
                if (place.geometry) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                }
            });

            placesService = new google.maps.places.PlacesService(map);
            document.getElementById("search").addEventListener("click", searchPlaces);
            document.getElementById("current-location-btn").addEventListener("click", zoomToCurrentLocation);
        }

        function searchPlaces() {
            const selectedType = document.getElementById("menu").value;
            const rating = document.getElementById("rating").value;
            const location = autocompleteTo.getPlace();

            if (!location || !location.geometry) {
                alert("Please enter a valid destination.");
                return;
            }

            map.setCenter(location.geometry.location);
            document.getElementById("results").innerHTML = "";
            clearMarkers();

            let placeTypes = [];
            if (selectedType === "rentals") {
                // Rentals case: show both car rentals and bike stores
                placeTypes = ["car_rental", "bicycle_store"];
            } else if (selectedType === "hotel") {
                // For hotels, use "lodging" to get proper residential accommodations
                placeTypes = ["lodging"];
            } else {
                placeTypes = [selectedType];
            }

            placeTypes.forEach((type) => {
                placesService.nearbySearch({
                        location: location.geometry.location,
                        radius: 5000,
                        type: type,
                    },
                    (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            let filtered = results.filter((place) => {
                                if (rating === "all") return true;
                                return place.rating >= parseFloat(rating);
                            });

                            // Updated Sorting: 
                            // 2. Sort primarily by reviews (descending),
                            // 3. then by rating (descending),
                            // 1. and finally, places with photos come before those without.
                            filtered.sort((a, b) => {
                                const reviewsA = a.user_ratings_total || 0;
                                const reviewsB = b.user_ratings_total || 0;
                                if (reviewsA !== reviewsB) {
                                    return reviewsB - reviewsA; // More reviews first
                                }
                                const ratingA = a.rating || 0;
                                const ratingB = b.rating || 0;
                                if (ratingA !== ratingB) {
                                    return ratingB - ratingA; // Higher rating next
                                }
                                const aHasPhoto = a.photos && a.photos.length > 0;
                                const bHasPhoto = b.photos && b.photos.length > 0;
                                if (aHasPhoto !== bHasPhoto) {
                                    return aHasPhoto ? -1 : 1;
                                }
                                return 0;
                            });

                            filtered.forEach((place) => {
                                placesService.getDetails({
                                    placeId: place.place_id
                                }, (details, status) => {
                                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                                        addRecommendation(details);
                                        addMarker(details);
                                    }
                                });
                            });
                        }
                    }
                );
            });
        }

        function addRecommendation(place) {
            const li = document.createElement("li");
            li.className = "result-item";

            // Hover event: Show the info window on map
            li.addEventListener("mouseover", () => {
                const entry = markerMap[place.place_id];
                if (entry) {
                    entry.infowindow.open(map, entry.marker);
                }
            });

            // Mouse out: Close the info window
            li.addEventListener("mouseout", () => {
                const entry = markerMap[place.place_id];
                if (entry) {
                    entry.infowindow.close();
                }
            });


            let photoUrl = place.photos ?
                place.photos[0].getUrl({
                    maxWidth: 400
                }) :
                "https://via.placeholder.com/400x200?text=No+Image";

            li.innerHTML = `
    <img src="${photoUrl}" alt="${place.name}" />
    <div class="result-name">${place.name}</div>
    <div class="result-rating">Rating: ${place.rating || 'N/A'} (${place.user_ratings_total || 0} reviews)</div>
    <div class="result-distance">Distance: Calculating...</div>
    <a class="gmaps-link" href="https://www.google.com/maps/place/?q=place_id:${place.place_id}" target="_blank">Open in Google Maps</a>
  `;
            if (currentPosition && place.geometry && place.geometry.location) {
                calculateDistance(
                    currentPosition,
                    place.geometry.location,
                    li.querySelector('.result-distance')
                );
            } else {
                li.querySelector('.result-distance').textContent =
                    'Enable location access to see distance';
            }
            li.addEventListener("click", () => {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            });

            document.getElementById("results").appendChild(li);
        }

        const markerMap = {}; // To store marker and info window together

        function addMarker(place) {
            let photoUrl = place.photos ?
                place.photos[0].getUrl({
                    maxWidth: 200
                }) :
                "https://via.placeholder.com/200x100?text=No+Image";

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
            });

            const infowindow = new google.maps.InfoWindow({
                content: `
          <div style="max-width:200px;">
            <img src="${photoUrl}" alt="${place.name}" style="width:100%; height:auto; border-radius:8px;"/>
            <strong>${place.name}</strong><br>
            Rating: ${place.rating || 'N/A'} (${place.user_ratings_total || 0} reviews)
          </div>
        `,
            });

            markerMap[place.place_id] = {
                marker,
                infowindow
            };

            marker.addListener("mouseover", () => infowindow.open(map, marker));
            marker.addListener("mouseout", () => infowindow.close());

            markers.push(marker);
        }

        function clearMarkers() {
            markers.forEach((marker) => marker.setMap(null));
            markers = [];
        }

        function calculateDistance(origin, destination, element) {
            const service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [origin],
                destinations: [destination],
                travelMode: 'DRIVING'
            }, (response, status) => {
                if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                    const distance = response.rows[0].elements[0].distance.text;
                    const duration = response.rows[0].elements[0].duration.text;
                    element.textContent = `${distance} away (${duration} drive)`;
                } else {
                    element.textContent = 'Distance unavailable';
                }
            });
        }

        function zoomToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        currentPosition = pos;
                        map.setCenter(pos);
                        map.setZoom(15);
                        if (currentLocationMarker) {
                            currentLocationMarker.setPosition(pos);
                        } else {
                            currentLocationMarker = new google.maps.Marker({
                                map: map,
                                position: pos,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "#ffffff",
                                    strokeWeight: 2,
                                },
                            });
                        }
                    },
                    () => {
                        alert("Error: The Geolocation service failed.");
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        }

        window.initMap = initMap;
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsjqV6vzVGJ-j_Qm7KjrmbBMCRDe-wNjw&libraries=places&callback=initMap" async defer></script>
</body>

</html>